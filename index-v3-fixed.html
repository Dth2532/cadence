<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Know Your Habits to Know Yourself">
  <meta name="theme-color" content="#667eea">
  <title>Cadence</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon-192.png">
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js').catch(e => console.log('SW failed'));
    }
    if (!window.storage) {
      window.storage = {
        async get(key) {
          const v = localStorage.getItem(key);
          return v ? { key, value: v } : null;
        },
        async set(key, value) {
          localStorage.setItem(key, value);
          return { key, value };
        }
      };
    }
  </script>
  <script type="text/babel">
    const { useState, useEffect } = React;
    
    function App() {
      const [tasks, setTasks] = useState([]);
      const [foods, setFoods] = useState([]);
      const [bedtime, setBedtime] = useState('');
      const [activeView, setActiveView] = useState('today');
      const [activeTab, setActiveTab] = useState('tasks');
      const [inputs, setInputs] = useState({ task: '', food: '', bedtime: '' });
      const [loading, setLoading] = useState(true);
      const [insightsLoading, setInsightsLoading] = useState(false);
      const [weeklyData, setWeeklyData] = useState(null);
      const [monthlyData, setMonthlyData] = useState(null);
      const today = new Date().toISOString().split('T')[0];

      useEffect(() => {
        loadData();
      }, []);

      useEffect(() => {
        if (activeView === 'insights' && !weeklyData) {
          loadInsights();
        }
      }, [activeView]);

      async function loadData() {
        try {
          const tasksResult = await window.storage.get(`tasks:${today}`);
          const foodsResult = await window.storage.get(`foods:${today}`);
          const bedtimeResult = await window.storage.get(`bedtime:${today}`);
          
          if (tasksResult) setTasks(JSON.parse(tasksResult.value));
          if (foodsResult) setFoods(JSON.parse(foodsResult.value));
          if (bedtimeResult) setBedtime(bedtimeResult.value);
        } catch (e) {
          console.log('Load failed:', e);
        }
        setLoading(false);
      }

      async function loadInsights() {
        setInsightsLoading(true);
        const weekly = await getRecap(7);
        const monthly = await getRecap(30);
        setWeeklyData(weekly);
        setMonthlyData(monthly);
        setInsightsLoading(false);
      }

      async function getRecap(days) {
        const taskFreq = {};
        const foodFreq = {};
        let totalTasks = 0;
        let totalMeals = 0;
        let daysTracked = 0;

        for (let i = 0; i < days; i++) {
          const date = new Date();
          date.setDate(date.getDate() - i);
          const dateStr = date.toISOString().split('T')[0];

          try {
            const tasksResult = await window.storage.get(`tasks:${dateStr}`);
            const foodsResult = await window.storage.get(`foods:${dateStr}`);
            const bedtimeResult = await window.storage.get(`bedtime:${dateStr}`);

            if (tasksResult || foodsResult || bedtimeResult) daysTracked++;

            if (tasksResult) {
              const tasks = JSON.parse(tasksResult.value);
              totalTasks += tasks.length;
              tasks.forEach(t => {
                const key = t.text.toLowerCase().trim();
                taskFreq[key] = (taskFreq[key] || 0) + 1;
              });
            }

            if (foodsResult) {
              const foods = JSON.parse(foodsResult.value);
              totalMeals += foods.length;
              foods.forEach(f => {
                const key = f.text.toLowerCase().trim();
                foodFreq[key] = (foodFreq[key] || 0) + 1;
              });
            }
          } catch {}
        }

        const topTasks = Object.entries(taskFreq).sort((a,b) => b[1] - a[1]).slice(0,3);
        const topFoods = Object.entries(foodFreq).sort((a,b) => b[1] - a[1]).slice(0,3);

        return { daysTracked, totalTasks, totalMeals, topTasks, topFoods };
      }

      async function addTask() {
        if (!inputs.task.trim()) return;
        const newTask = { 
          id: Date.now(), 
          text: inputs.task, 
          time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) 
        };
        const updated = [...tasks, newTask];
        setTasks(updated);
        await window.storage.set(`tasks:${today}`, JSON.stringify(updated));
        setInputs({ ...inputs, task: '' });
      }

      async function deleteTask(id) {
        const updated = tasks.filter(t => t.id !== id);
        setTasks(updated);
        await window.storage.set(`tasks:${today}`, JSON.stringify(updated));
      }

      async function addFood() {
        if (!inputs.food.trim()) return;
        const newFood = { 
          id: Date.now(), 
          text: inputs.food, 
          time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) 
        };
        const updated = [...foods, newFood];
        setFoods(updated);
        await window.storage.set(`foods:${today}`, JSON.stringify(updated));
        setInputs({ ...inputs, food: '' });
      }

      async function deleteFood(id) {
        const updated = foods.filter(f => f.id !== id);
        setFoods(updated);
        await window.storage.set(`foods:${today}`, JSON.stringify(updated));
      }

      async function saveBedtime() {
        if (!inputs.bedtime) return;
        setBedtime(inputs.bedtime);
        await window.storage.set(`bedtime:${today}`, inputs.bedtime);
      }

      if (loading) {
        return <div style={{minHeight:'100vh',display:'flex',alignItems:'center',justifyContent:'center',background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'}}>
          <div style={{color:'white',fontSize:'18px'}}>Loading...</div>
        </div>;
      }

      return (
        <div style={{minHeight:'100vh',background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',padding:'20px'}}>
          <div style={{maxWidth:'800px',margin:'0 auto'}}>
            {/* Header */}
            <div style={{background:'white',borderRadius:'12px',padding:'24px',marginBottom:'20px',boxShadow:'0 4px 20px rgba(0,0,0,0.1)'}}>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:'20px'}}>
                <div>
                  <h1 style={{margin:'0 0 8px 0',fontSize:'32px',fontWeight:'700',color:'#111'}}>Cadence</h1>
                  <p style={{margin:'0 0 8px 0',color:'#666',fontSize:'14px'}}>Know Your Habits to Know Yourself</p>
                  <p style={{margin:'0',color:'#999',fontSize:'12px'}}>{new Date().toLocaleDateString('en-US', {weekday:'long',month:'short',day:'numeric',year:'numeric'})}</p>
                </div>
                <div style={{display:'flex',gap:'8px'}}>
                  <button onClick={() => setActiveView('today')} style={{background:activeView==='today'?'#dbeafe':'transparent',color:activeView==='today'?'#1e40af':'#999',border:'1px solid #e5e7eb',padding:'8px 16px',borderRadius:'8px',fontSize:'12px',fontWeight:'600',cursor:'pointer'}}>
                    Today
                  </button>
                  <button onClick={() => setActiveView('insights')} style={{background:activeView==='insights'?'#dbeafe':'transparent',color:activeView==='insights'?'#1e40af':'#999',border:'1px solid #e5e7eb',padding:'8px 16px',borderRadius:'8px',fontSize:'12px',fontWeight:'600',cursor:'pointer'}}>
                    Insights
                  </button>
                </div>
              </div>
              
              {/* Tabs - Only show in Today view */}
              {activeView === 'today' && (
                <div style={{display:'flex',gap:'8px',borderBottom:'1px solid #e5e7eb'}}>
                  <button onClick={() => setActiveTab('tasks')} style={{background:'transparent',border:'none',padding:'12px 16px',fontSize:'14px',fontWeight:'500',color:activeTab==='tasks'?'#667eea':'#999',borderBottom:activeTab==='tasks'?'2px solid #667eea':'2px solid transparent',marginBottom:'-1px',cursor:'pointer'}}>
                    Tasks
                  </button>
                  <button onClick={() => setActiveTab('food')} style={{background:'transparent',border:'none',padding:'12px 16px',fontSize:'14px',fontWeight:'500',color:activeTab==='food'?'#667eea':'#999',borderBottom:activeTab==='food'?'2px solid #667eea':'2px solid transparent',marginBottom:'-1px',cursor:'pointer'}}>
                    Food
                  </button>
                  <button onClick={() => setActiveTab('sleep')} style={{background:'transparent',border:'none',padding:'12px 16px',fontSize:'14px',fontWeight:'500',color:activeTab==='sleep'?'#667eea':'#999',borderBottom:activeTab==='sleep'?'2px solid #667eea':'2px solid transparent',marginBottom:'-1px',cursor:'pointer'}}>
                    Sleep
                  </button>
                </div>
              )}
            </div>

            {/* Today View */}
            {activeView === 'today' && (
              <>
                {/* Stats Cards */}
                <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(150px, 1fr))',gap:'16px',marginBottom:'20px'}}>
                  <div style={{background:'white',borderRadius:'12px',padding:'16px',boxShadow:'0 2px 8px rgba(0,0,0,0.1)'}}>
                    <div style={{fontSize:'11px',fontWeight:'600',color:'#999',marginBottom:'4px',textTransform:'uppercase'}}>Tasks Today</div>
                    <div style={{fontSize:'28px',fontWeight:'700',color:'#111'}}>{tasks.length}</div>
                  </div>
                  <div style={{background:'white',borderRadius:'12px',padding:'16px',boxShadow:'0 2px 8px rgba(0,0,0,0.1)'}}>
                    <div style={{fontSize:'11px',fontWeight:'600',color:'#999',marginBottom:'4px',textTransform:'uppercase'}}>Meals</div>
                    <div style={{fontSize:'28px',fontWeight:'700',color:'#111'}}>{foods.length}</div>
                  </div>
                  <div style={{background:'white',borderRadius:'12px',padding:'16px',boxShadow:'0 2px 8px rgba(0,0,0,0.1)'}}>
                    <div style={{fontSize:'11px',fontWeight:'600',color:'#999',marginBottom:'4px',textTransform:'uppercase'}}>Bedtime</div>
                    <div style={{fontSize:'20px',fontWeight:'700',color:'#111',fontFamily:'monospace'}}>
                      {bedtime ? new Date(`2000-01-01T${bedtime}`).toLocaleTimeString('en-US', {hour:'numeric',minute:'2-digit',hour12:true}) : '‚Äî'}
                    </div>
                  </div>
                </div>

                {/* Tasks Tab */}
                {activeTab === 'tasks' && (
                  <div style={{background:'white',borderRadius:'12px',padding:'24px',boxShadow:'0 4px 20px rgba(0,0,0,0.1)'}}>
                    <h2 style={{margin:'0 0 20px 0',fontSize:'20px',fontWeight:'600'}}>Completed Tasks</h2>
                    
                    <div style={{display:'flex',gap:'12px',marginBottom:'24px'}}>
                      <input
                        type="text"
                        value={inputs.task}
                        onChange={(e) => setInputs({...inputs, task: e.target.value})}
                        onKeyPress={(e) => e.key === 'Enter' && addTask()}
                        placeholder="What did you accomplish?"
                        style={{flex:1,padding:'12px',border:'1px solid #ddd',borderRadius:'8px',fontSize:'14px'}}
                      />
                      <button onClick={addTask} style={{background:'#667eea',color:'white',border:'none',padding:'12px 24px',borderRadius:'8px',fontSize:'14px',fontWeight:'600',cursor:'pointer'}}>
                        Add
                      </button>
                    </div>

                    <div style={{display:'flex',flexDirection:'column',gap:'8px'}}>
                      {tasks.length === 0 ? (
                        <p style={{textAlign:'center',color:'#999',padding:'40px 20px'}}>No tasks yet!</p>
                      ) : (
                        tasks.map(task => (
                          <div key={task.id} style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'12px',background:'#f9fafb',borderRadius:'8px',border:'1px solid #e5e7eb'}}>
                            <div style={{flex:1}}>
                              <div style={{fontSize:'14px',fontWeight:'500',color:'#111',marginBottom:'4px'}}>{task.text}</div>
                              <div style={{fontSize:'12px',color:'#999'}}>{task.time}</div>
                            </div>
                            <button onClick={() => deleteTask(task.id)} style={{background:'none',border:'none',cursor:'pointer',padding:'4px',color:'#999',fontSize:'18px'}}>√ó</button>
                          </div>
                        ))
                      )}
                    </div>
                  </div>
                )}

                {/* Food Tab */}
                {activeTab === 'food' && (
                  <div style={{background:'white',borderRadius:'12px',padding:'24px',boxShadow:'0 4px 20px rgba(0,0,0,0.1)'}}>
                    <h2 style={{margin:'0 0 20px 0',fontSize:'20px',fontWeight:'600'}}>Food Log</h2>
                    
                    <div style={{display:'flex',gap:'12px',marginBottom:'24px'}}>
                      <input
                        type="text"
                        value={inputs.food}
                        onChange={(e) => setInputs({...inputs, food: e.target.value})}
                        onKeyPress={(e) => e.key === 'Enter' && addFood()}
                        placeholder="What did you eat?"
                        style={{flex:1,padding:'12px',border:'1px solid #ddd',borderRadius:'8px',fontSize:'14px'}}
                      />
                      <button onClick={addFood} style={{background:'#667eea',color:'white',border:'none',padding:'12px 24px',borderRadius:'8px',fontSize:'14px',fontWeight:'600',cursor:'pointer'}}>
                        Add
                      </button>
                    </div>

                    <div style={{display:'flex',flexDirection:'column',gap:'8px'}}>
                      {foods.length === 0 ? (
                        <p style={{textAlign:'center',color:'#999',padding:'40px 20px'}}>No meals yet!</p>
                      ) : (
                        foods.map(food => (
                          <div key={food.id} style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'12px',background:'#f9fafb',borderRadius:'8px',border:'1px solid #e5e7eb'}}>
                            <div style={{flex:1}}>
                              <div style={{fontSize:'14px',fontWeight:'500',color:'#111',marginBottom:'4px'}}>{food.text}</div>
                              <div style={{fontSize:'12px',color:'#999'}}>{food.time}</div>
                            </div>
                            <button onClick={() => deleteFood(food.id)} style={{background:'none',border:'none',cursor:'pointer',padding:'4px',color:'#999',fontSize:'18px'}}>√ó</button>
                          </div>
                        ))
                      )}
                    </div>
                  </div>
                )}

                {/* Sleep Tab */}
                {activeTab === 'sleep' && (
                  <div style={{background:'white',borderRadius:'12px',padding:'24px',boxShadow:'0 4px 20px rgba(0,0,0,0.1)'}}>
                    <h2 style={{margin:'0 0 20px 0',fontSize:'20px',fontWeight:'600'}}>Sleep Schedule</h2>
                    
                    <div style={{display:'flex',gap:'12px',marginBottom:'24px'}}>
                      <input
                        type="time"
                        value={inputs.bedtime}
                        onChange={(e) => setInputs({...inputs, bedtime: e.target.value})}
                        style={{flex:1,padding:'12px',border:'1px solid #ddd',borderRadius:'8px',fontSize:'14px'}}
                      />
                      <button onClick={saveBedtime} style={{background:'#667eea',color:'white',border:'none',padding:'12px 24px',borderRadius:'8px',fontSize:'14px',fontWeight:'600',cursor:'pointer'}}>
                        Save
                      </button>
                    </div>

                    {bedtime ? (
                      <div style={{padding:'32px',background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',borderRadius:'12px',textAlign:'center',color:'white'}}>
                        <div style={{fontSize:'48px',marginBottom:'12px'}}>üåô</div>
                        <div style={{fontSize:'14px',marginBottom:'8px',opacity:0.9}}>Bedtime</div>
                        <div style={{fontSize:'48px',fontWeight:'700',fontFamily:'monospace'}}>
                          {new Date(`2000-01-01T${bedtime}`).toLocaleTimeString('en-US', {hour:'numeric',minute:'2-digit',hour12:true})}
                        </div>
                      </div>
                    ) : (
                      <p style={{textAlign:'center',color:'#999',padding:'40px 20px'}}>No bedtime set!</p>
                    )}
                  </div>
                )}
              </>
            )}

            {/* Insights View */}
            {activeView === 'insights' && (
              insightsLoading ? (
                <div style={{background:'white',borderRadius:'12px',padding:'48px',textAlign:'center',boxShadow:'0 4px 20px rgba(0,0,0,0.1)'}}>
                  <div style={{color:'#999'}}>Analyzing your habits...</div>
                </div>
              ) : weeklyData && monthlyData ? (
                <>
                  {/* Weekly */}
                  <div style={{background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',borderRadius:'12px',padding:'32px',color:'white',marginBottom:'20px',boxShadow:'0 4px 20px rgba(0,0,0,0.1)'}}>
                    <h2 style={{fontSize:'24px',fontWeight:'700',margin:'0 0 8px 0'}}>üìä Weekly Recap</h2>
                    <p style={{fontSize:'14px',opacity:0.9,margin:'0 0 24px 0'}}>Last 7 days</p>

                    <div style={{display:'grid',gridTemplateColumns:'repeat(3, 1fr)',gap:'16px',marginBottom:'24px'}}>
                      <div>
                        <div style={{fontSize:'12px',opacity:0.8,marginBottom:'4px'}}>Days</div>
                        <div style={{fontSize:'28px',fontWeight:'700'}}>{weeklyData.daysTracked}/7</div>
                      </div>
                      <div>
                        <div style={{fontSize:'12px',opacity:0.8',marginBottom:'4px'}}>Tasks</div>
                        <div style={{fontSize:'28px',fontWeight:'700'}}>{weeklyData.totalTasks}</div>
                      </div>
                      <div>
                        <div style={{fontSize:'12px',opacity:0.8,marginBottom:'4px'}}>Meals</div>
                        <div style={{fontSize:'28px',fontWeight:'700'}}>{weeklyData.totalMeals}</div>
                      </div>
                    </div>

                    <div style={{background:'rgba(255,255,255,0.15)',padding:'20px',borderRadius:'12px'}}>
                      <h3 style={{fontSize:'16px',fontWeight:'600',margin:'0 0 16px 0'}}>üèÜ Top Habits</h3>
                      
                      {weeklyData.topTasks.length > 0 && (
                        <div style={{marginBottom:'16px'}}>
                          <div style={{fontSize:'13px',fontWeight:'600',marginBottom:'8px'}}>Tasks</div>
                          {weeklyData.topTasks.map(([task, count], i) => (
                            <div key={i} style={{display:'flex',justifyContent:'space-between',padding:'8px 0',borderBottom:i<2?'1px solid rgba(255,255,255,0.1)':'none'}}>
                              <span style={{textTransform:'capitalize'}}>#{i+1} {task}</span>
                              <span style={{fontWeight:'700'}}>{count}x</span>
                            </div>
                          ))}
                        </div>
                      )}

                      {weeklyData.topFoods.length > 0 && (
                        <div>
                          <div style={{fontSize:'13px',fontWeight:'600',marginBottom:'8px'}}>Foods</div>
                          {weeklyData.topFoods.map(([food, count], i) => (
                            <div key={i} style={{display:'flex',justifyContent:'space-between',padding:'8px 0',borderBottom:i<2?'1px solid rgba(255,255,255,0.1)':'none'}}>
                              <span style={{textTransform:'capitalize'}}>#{i+1} {food}</span>
                              <span style={{fontWeight:'700'}}>{count}x</span>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Monthly */}
                  <div style={{background:'white',borderRadius:'12px',padding:'32px',boxShadow:'0 4px 20px rgba(0,0,0,0.1)'}}>
                    <h2 style={{fontSize:'24px',fontWeight:'700',color:'#111',margin:'0 0 8px 0'}}>üìà Monthly Recap</h2>
                    <p style={{fontSize:'14px',color:'#666',margin:'0 0 24px 0'}}>Last 30 days</p>

                    <div style={{display:'grid',gridTemplateColumns:'repeat(3, 1fr)',gap:'16px',marginBottom:'24px'}}>
                      <div style={{background:'#f0fdf4',padding:'16px',borderRadius:'8px'}}>
                        <div style={{fontSize:'11px',fontWeight:'600',color:'#166534',marginBottom:'4px'}}>Days</div>
                        <div style={{fontSize:'24px',fontWeight:'700',color:'#166534'}}>{monthlyData.daysTracked}</div>
                      </div>
                      <div style={{background:'#eff6ff',padding:'16px',borderRadius:'8px'}}>
                        <div style={{fontSize:'11px',fontWeight:'600',color:'#1e40af',marginBottom:'4px'}}>Tasks</div>
                        <div style={{fontSize:'24px',fontWeight:'700',color:'#1e40af'}}>{monthlyData.totalTasks}</div>
                      </div>
                      <div style={{background:'#fff7ed',padding:'16px',borderRadius:'8px'}}>
                        <div style={{fontSize:'11px',fontWeight:'600',color:'#9a3412',marginBottom:'4px'}}>Meals</div>
                        <div style={{fontSize:'24px',fontWeight:'700',color:'#9a3412'}}>{monthlyData.totalMeals}</div>
                      </div>
                    </div>

                    <div style={{background:'#f9fafb',padding:'20px',borderRadius:'12px'}}>
                      <h3 style={{fontSize:'16px',fontWeight:'600',color:'#111',margin:'0 0 12px 0'}}>üèÜ Top Habits</h3>
                      
                      {monthlyData.topTasks.length > 0 && (
                        <div style={{marginBottom:'12px'}}>
                          <div style={{fontSize:'13px',fontWeight:'600',color:'#666',marginBottom:'8px'}}>Tasks</div>
                          {monthlyData.topTasks.map(([task, count], i) => (
                            <div key={i} style={{display:'flex',justifyContent:'space-between',padding:'10px',background:'white',borderRadius:'8px',marginBottom:'6px'}}>
                              <span style={{fontWeight:'500'}}>{i===0?'ü•á':i===1?'ü•à':'ü•â'} {task}</span>
                              <span style={{fontWeight:'700',color:'#666'}}>{count}x</span>
                            </div>
                          ))}
                        </div>
                      )}

                      {monthlyData.topFoods.length > 0 && (
                        <div>
                          <div style={{fontSize:'13px',fontWeight:'600',color:'#666',marginBottom:'8px'}}>Foods</div>
                          {monthlyData.topFoods.map(([food, count], i) => (
                            <div key={i} style={{display:'flex',justifyContent:'space-between',padding:'10px',background:'white',borderRadius:'8px',marginBottom:'6px'}}>
                              <span style={{fontWeight:'500'}}>{i===0?'ü•á':i===1?'ü•à':'ü•â'} {food}</span>
                              <span style={{fontWeight:'700',color:'#666'}}>{count}x</span>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>
                </>
              ) : null
            )}
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
