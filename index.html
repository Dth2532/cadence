<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Know Your Habits to Know Yourself">
  <meta name="theme-color" content="#667eea">
  <title>Cadence</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon-192.png">
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js').catch(e => console.log('SW failed'));
    }
    if (!window.storage) {
      window.storage = {
        async get(key) {
          const v = localStorage.getItem(key);
          return v ? { key, value: v } : null;
        },
        async set(key, value) {
          localStorage.setItem(key, value);
          return { key, value };
        }
      };
    }
  </script>
  <script type="text/babel">
    const { useState, useEffect } = React;
    
    function App() {
      const [tasks, setTasks] = useState([]);
      const [foods, setFoods] = useState([]);
      const [bedtime, setBedtime] = useState('');
      const [activeView, setActiveView] = useState('today');
      const [activeTab, setActiveTab] = useState('tasks');
      const [inputs, setInputs] = useState({ task: '', food: '', bedtime: '' });
      const [loading, setLoading] = useState(true);
      const [currentMonth, setCurrentMonth] = useState(new Date());
      const [calendarData, setCalendarData] = useState({});
      const [calendarLoading, setCalendarLoading] = useState(false);
      const today = new Date().toISOString().split('T')[0];

      useEffect(() => {
        loadData();
      }, []);

      useEffect(() => {
        if (activeView === 'calendar') {
          loadCalendarData();
        }
      }, [activeView, currentMonth]);

      async function loadData() {
        try {
          const tasksResult = await window.storage.get(`tasks:${today}`);
          const foodsResult = await window.storage.get(`foods:${today}`);
          const bedtimeResult = await window.storage.get(`bedtime:${today}`);
          
          if (tasksResult) setTasks(JSON.parse(tasksResult.value));
          if (foodsResult) setFoods(JSON.parse(foodsResult.value));
          if (bedtimeResult) setBedtime(bedtimeResult.value);
        } catch (e) {
          console.log('Load failed:', e);
        }
        setLoading(false);
      }

      async function loadCalendarData() {
        setCalendarLoading(true);
        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const data = {};

        for (let day = 1; day <= daysInMonth; day++) {
          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          try {
            const tasksResult = await window.storage.get(`tasks:${dateStr}`);
            const foodsResult = await window.storage.get(`foods:${dateStr}`);
            const bedtimeResult = await window.storage.get(`bedtime:${dateStr}`);

            data[day] = {
              hasTasks: tasksResult && JSON.parse(tasksResult.value).length > 0,
              hasFoods: foodsResult && JSON.parse(foodsResult.value).length > 0,
              hasBedtime: !!bedtimeResult
            };
          } catch {
            data[day] = { hasTasks: false, hasFoods: false, hasBedtime: false };
          }
        }

        setCalendarData(data);
        setCalendarLoading(false);
      }

      async function addTask() {
        if (!inputs.task.trim()) return;
        const newTask = { 
          id: Date.now(), 
          text: inputs.task, 
          time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) 
        };
        const updated = [...tasks, newTask];
        setTasks(updated);
        await window.storage.set(`tasks:${today}`, JSON.stringify(updated));
        setInputs({ ...inputs, task: '' });
      }

      async function deleteTask(id) {
        const updated = tasks.filter(t => t.id !== id);
        setTasks(updated);
        await window.storage.set(`tasks:${today}`, JSON.stringify(updated));
      }

      async function addFood() {
        if (!inputs.food.trim()) return;
        const newFood = { 
          id: Date.now(), 
          text: inputs.food, 
          time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) 
        };
        const updated = [...foods, newFood];
        setFoods(updated);
        await window.storage.set(`foods:${today}`, JSON.stringify(updated));
        setInputs({ ...inputs, food: '' });
      }

      async function deleteFood(id) {
        const updated = foods.filter(f => f.id !== id);
        setFoods(updated);
        await window.storage.set(`foods:${today}`, JSON.stringify(updated));
      }

      async function saveBedtime() {
        if (!inputs.bedtime) return;
        setBedtime(inputs.bedtime);
        await window.storage.set(`bedtime:${today}`, inputs.bedtime);
      }

      function previousMonth() {
        setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1));
      }

      function nextMonth() {
        setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1));
      }

      function getCalendarDays() {
        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth();
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        return { firstDay, daysInMonth };
      }

      if (loading) {
        return <div style={{minHeight:'100vh',display:'flex',alignItems:'center',justifyContent:'center',background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'}}>
          <div style={{color:'white',fontSize:'18px'}}>Loading...</div>
        </div>;
      }

      const { firstDay, daysInMonth } = getCalendarDays();
      const monthName = currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

      return (
        <div style={{minHeight:'100vh',background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',padding:'20px'}}>
          <div style={{maxWidth:'800px',margin:'0 auto'}}>
            {/* Header */}
            <div style={{background:'white',borderRadius:'12px',padding:'24px',marginBottom:'20px',boxShadow:'0 4px 20px rgba(0,0,0,0.1)'}}>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:'20px'}}>
                <div>
                  <h1 style={{margin:'0 0 8px 0',fontSize:'32px',fontWeight:'700',color:'#111'}}>Cadence</h1>
                  <p style={{margin:'0 0 8px 0',color:'#666',fontSize:'14px'}}>Know Your Habits to Know Yourself</p>
                  <p style={{margin:'0',color:'#999',fontSize:'12px'}}>{new Date().toLocaleDateString('en-US', {weekday:'long',month:'short',day:'numeric',year:'numeric'})}</p>
                </div>
                <div style={{display:'flex',gap:'8px'}}>
                  <button onClick={() => setActiveView('today')} style={{background:activeView==='today'?'#dbeafe':'transparent',color:activeView==='today'?'#1e40af':'#999',border:'1px solid #e5e7eb',padding:'8px 16px',borderRadius:'8px',fontSize:'12px',fontWeight:'600',cursor:'pointer'}}>
                    Today
                  </button>
                  <button onClick={() => setActiveView('calendar')} style={{background:activeView==='calendar'?'#dbeafe':'transparent',color:activeView==='calendar'?'#1e40af':'#999',border:'1px solid #e5e7eb',padding:'8px 16px',borderRadius:'8px',fontSize:'12px',fontWeight:'600',cursor:'pointer'}}>
                    Calendar
                  </button>
                </div>
              </div>
              
              {activeView === 'today' && (
                <div style={{display:'flex',gap:'8px',borderBottom:'1px solid #e5e7eb'}}>
                  <button onClick={() => setActiveTab('tasks')} style={{background:'transparent',border:'none',padding:'12px 16px',fontSize:'14px',fontWeight:'500',color:activeTab==='tasks'?'#667eea':'#999',borderBottom:activeTab==='tasks'?'2px solid #667eea':'2px solid transparent',marginBottom:'-1px',cursor:'pointer'}}>
                    Tasks
                  </button>
                  <button onClick={() => setActiveTab('food')} style={{background:'transparent',border:'none',padding:'12px 16px',fontSize:'14px',fontWeight:'500',color:activeTab==='food'?'#667eea':'#999',borderBottom:activeTab==='food'?'2px solid #667eea':'2px solid transparent',marginBottom:'-1px',cursor:'pointer'}}>
                    Food
                  </button>
                  <button onClick={() => setActiveTab('sleep')} style={{background:'transparent',border:'none',padding:'12px 16px',fontSize:'14px',fontWeight:'500',color:activeTab==='sleep'?'#667eea':'#999',borderBottom:activeTab==='sleep'?'2px solid #667eea':'2px solid transparent',marginBottom:'-1px',cursor:'pointer'}}>
                    Sleep
                  </button>
                </div>
              )}
            </div>

            {activeView === 'today' && (
              <>
                <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(150px, 1fr))',gap:'16px',marginBottom:'20px'}}>
                  <div style={{background:'white',borderRadius:'12px',padding:'16px',boxShadow:'0 2px 8px rgba(0,0,0,0.1)'}}>
                    <div style={{fontSize:'11px',fontWeight:'600',color:'#999',marginBottom:'4px',textTransform:'uppercase'}}>Tasks</div>
                    <div style={{fontSize:'28px',fontWeight:'700',color:'#111'}}>{tasks.length}</div>
                  </div>
                  <div style={{background:'white',borderRadius:'12px',padding:'16px',boxShadow:'0 2px 8px rgba(0,0,0,0.1)'}}>
                    <div style={{fontSize:'11px',fontWeight:'600',color:'#999',marginBottom:'4px',textTransform:'uppercase'}}>Meals</div>
                    <div style={{fontSize:'28px',fontWeight:'700',color:'#111'}}>{foods.length}</div>
                  </div>
                  <div style={{background:'white',borderRadius:'12px',padding:'16px',boxShadow:'0 2px 8px rgba(0,0,0,0.1)'}}>
                    <div style={{fontSize:'11px',fontWeight:'600',color:'#999',marginBottom:'4px',textTransform:'uppercase'}}>Bedtime</div>
                    <div style={{fontSize:'20px',fontWeight:'700',color:'#111',fontFamily:'monospace'}}>
                      {bedtime ? new Date(`2000-01-01T${bedtime}`).toLocaleTimeString('en-US', {hour:'numeric',minute:'2-digit',hour12:true}) : '‚Äî'}
                    </div>
                  </div>
                </div>

                {activeTab === 'tasks' && (
                  <div style={{background:'white',borderRadius:'12px',padding:'24px',boxShadow:'0 4px 20px rgba(0,0,0,0.1)'}}>
                    <h2 style={{margin:'0 0 20px 0',fontSize:'20px',fontWeight:'600'}}>Completed Tasks</h2>
                    <div style={{display:'flex',gap:'12px',marginBottom:'24px'}}>
                      <input type="text" value={inputs.task} onChange={(e) => setInputs({...inputs, task: e.target.value})} onKeyPress={(e) => e.key === 'Enter' && addTask()} placeholder="What did you accomplish?" style={{flex:1,padding:'12px',border:'1px solid #ddd',borderRadius:'8px',fontSize:'14px'}} />
                      <button onClick={addTask} style={{background:'#667eea',color:'white',border:'none',padding:'12px 24px',borderRadius:'8px',fontSize:'14px',fontWeight:'600',cursor:'pointer'}}>Add</button>
                    </div>
                    <div style={{display:'flex',flexDirection:'column',gap:'8px'}}>
                      {tasks.length === 0 ? <p style={{textAlign:'center',color:'#999',padding:'40px 20px'}}>No tasks yet!</p> : tasks.map(task => (
                        <div key={task.id} style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'12px',background:'#f9fafb',borderRadius:'8px',border:'1px solid #e5e7eb'}}>
                          <div style={{flex:1}}><div style={{fontSize:'14px',fontWeight:'500',color:'#111',marginBottom:'4px'}}>{task.text}</div><div style={{fontSize:'12px',color:'#999'}}>{task.time}</div></div>
                          <button onClick={() => deleteTask(task.id)} style={{background:'none',border:'none',cursor:'pointer',padding:'4px',color:'#999',fontSize:'18px'}}>√ó</button>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {activeTab === 'food' && (
                  <div style={{background:'white',borderRadius:'12px',padding:'24px',boxShadow:'0 4px 20px rgba(0,0,0,0.1)'}}>
                    <h2 style={{margin:'0 0 20px 0',fontSize:'20px',fontWeight:'600'}}>Food Log</h2>
                    <div style={{display:'flex',gap:'12px',marginBottom:'24px'}}>
                      <input type="text" value={inputs.food} onChange={(e) => setInputs({...inputs, food: e.target.value})} onKeyPress={(e) => e.key === 'Enter' && addFood()} placeholder="What did you eat?" style={{flex:1,padding:'12px',border:'1px solid #ddd',borderRadius:'8px',fontSize:'14px'}} />
                      <button onClick={addFood} style={{background:'#667eea',color:'white',border:'none',padding:'12px 24px',borderRadius:'8px',fontSize:'14px',fontWeight:'600',cursor:'pointer'}}>Add</button>
                    </div>
                    <div style={{display:'flex',flexDirection:'column',gap:'8px'}}>
                      {foods.length === 0 ? <p style={{textAlign:'center',color:'#999',padding:'40px 20px'}}>No meals yet!</p> : foods.map(food => (
                        <div key={food.id} style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'12px',background:'#f9fafb',borderRadius:'8px',border:'1px solid #e5e7eb'}}>
                          <div style={{flex:1}}><div style={{fontSize:'14px',fontWeight:'500',color:'#111',marginBottom:'4px'}}>{food.text}</div><div style={{fontSize:'12px',color:'#999'}}>{food.time}</div></div>
                          <button onClick={() => deleteFood(food.id)} style={{background:'none',border:'none',cursor:'pointer',padding:'4px',color:'#999',fontSize:'18px'}}>√ó</button>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {activeTab === 'sleep' && (
                  <div style={{background:'white',borderRadius:'12px',padding:'24px',boxShadow:'0 4px 20px rgba(0,0,0,0.1)'}}>
                    <h2 style={{margin:'0 0 20px 0',fontSize:'20px',fontWeight:'600'}}>Sleep Schedule</h2>
                    <div style={{display:'flex',gap:'12px',marginBottom:'24px'}}>
                      <input type="time" value={inputs.bedtime} onChange={(e) => setInputs({...inputs, bedtime: e.target.value})} style={{flex:1,padding:'12px',border:'1px solid #ddd',borderRadius:'8px',fontSize:'14px'}} />
                      <button onClick={saveBedtime} style={{background:'#667eea',color:'white',border:'none',padding:'12px 24px',borderRadius:'8px',fontSize:'14px',fontWeight:'600',cursor:'pointer'}}>Save</button>
                    </div>
                    {bedtime ? (
                      <div style={{padding:'32px',background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',borderRadius:'12px',textAlign:'center',color:'white'}}>
                        <div style={{fontSize:'48px',marginBottom:'12px'}}>üåô</div>
                        <div style={{fontSize:'14px',marginBottom:'8px',opacity:0.9}}>Bedtime</div>
                        <div style={{fontSize:'48px',fontWeight:'700',fontFamily:'monospace'}}>
                          {new Date(`2000-01-01T${bedtime}`).toLocaleTimeString('en-US', {hour:'numeric',minute:'2-digit',hour12:true})}
                        </div>
                      </div>
                    ) : <p style={{textAlign:'center',color:'#999',padding:'40px 20px'}}>No bedtime set!</p>}
                  </div>
                )}
              </>
            )}

            {activeView === 'calendar' && (
              <div style={{background:'white',borderRadius:'12px',padding:'24px',boxShadow:'0 4px 20px rgba(0,0,0,0.1)'}}>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'24px'}}>
                  <button onClick={previousMonth} style={{background:'#f3f4f6',border:'none',padding:'8px 12px',borderRadius:'8px',cursor:'pointer',fontSize:'18px'}}>‚Üê</button>
                  <h2 style={{fontSize:'20px',fontWeight:'600',color:'#111',margin:0}}>{monthName}</h2>
                  <button onClick={nextMonth} style={{background:'#f3f4f6',border:'none',padding:'8px 12px',borderRadius:'8px',cursor:'pointer',fontSize:'18px'}}>‚Üí</button>
                </div>

                {calendarLoading ? (
                  <div style={{textAlign:'center',padding:'40px',color:'#999'}}>Loading calendar...</div>
                ) : (
                  <>
                    <div style={{display:'grid',gridTemplateColumns:'repeat(7, 1fr)',gap:'8px',marginBottom:'8px'}}>
                      {['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(day => (
                        <div key={day} style={{textAlign:'center',fontSize:'12px',fontWeight:'600',color:'#999',padding:'8px'}}>{day}</div>
                      ))}
                    </div>
                    <div style={{display:'grid',gridTemplateColumns:'repeat(7, 1fr)',gap:'8px'}}>
                      {Array(firstDay).fill(null).map((_, i) => <div key={`empty-${i}`} />)}
                      {Array(daysInMonth).fill(null).map((_, i) => {
                        const day = i + 1;
                        const dateStr = `${currentMonth.getFullYear()}-${String(currentMonth.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const isToday = dateStr === today;
                        const dayData = calendarData[day] || {};
                        const hasAny = dayData.hasTasks || dayData.hasFoods || dayData.hasBedtime;

                        return (
                          <div key={day} style={{aspectRatio:'1',border:isToday?'2px solid #667eea':'1px solid #e5e7eb',borderRadius:'8px',padding:'8px',background:hasAny?'#f0fdf4':'white',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center'}}>
                            <div style={{fontSize:'14px',fontWeight:'600',color:'#111',marginBottom:'4px'}}>{day}</div>
                            <div style={{display:'flex',gap:'2px'}}>
                              {dayData.hasTasks && <div style={{width:'6px',height:'6px',borderRadius:'50%',background:'#10b981'}} />}
                              {dayData.hasFoods && <div style={{width:'6px',height:'6px',borderRadius:'50%',background:'#f59e0b'}} />}
                              {dayData.hasBedtime && <div style={{width:'6px',height:'6px',borderRadius:'50%',background:'#8b5cf6'}} />}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                    <div style={{marginTop:'20px',display:'flex',gap:'16px',fontSize:'12px',color:'#666',justifyContent:'center'}}>
                      <div style={{display:'flex',alignItems:'center',gap:'6px'}}><div style={{width:'8px',height:'8px',borderRadius:'50%',background:'#10b981'}} />Tasks</div>
                      <div style={{display:'flex',alignItems:'center',gap:'6px'}}><div style={{width:'8px',height:'8px',borderRadius:'50%',background:'#f59e0b'}} />Food</div>
                      <div style={{display:'flex',alignItems:'center',gap:'6px'}}><div style={{width:'8px',height:'8px',borderRadius:'50%',background:'#8b5cf6'}} />Sleep</div>
                    </div>
                  </>
                )}
              </div>
            )}
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
